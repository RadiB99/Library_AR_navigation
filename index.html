<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Library AR Experience</title>

    <!-- A-Frame + AR.js -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.2/aframe/build/aframe-ar.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #startScreen {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: black;
        color: white;
        font-size: 1.2em;
        z-index: 100;
        cursor: pointer;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        background: #f3f3f3;
      }
    </style>
  </head>

  <body>
    <!-- Start Overlay -->
    <div id="startScreen">üëã Tap anywhere to start AR experience</div>

    <!-- AR Scene -->
    <a-scene
      embedded
      arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false;"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; antialias: true;"
      device-orientation-permission-ui="enabled: true"
      style="display: none"
    >
      <a-camera id="userCam" position="0 1.6 0" camera></a-camera>
    </a-scene>

    <script>
      const startScreen = document.getElementById("startScreen");
      const scene = document.querySelector("a-scene");

      // Handle both tap and touch (iPhone friendly)
      startScreen.addEventListener("click", startAR);
      startScreen.addEventListener("touchstart", startAR);

      function startAR() {
        startScreen.style.display = "none";
        scene.style.display = "block";
        requestIOSPermission();
        initARScene();
      }

      // iOS 13+ motion sensor permission fix
      function requestIOSPermission() {
        if (
          typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function"
        ) {
          DeviceMotionEvent.requestPermission()
            .then((response) => {
              console.log("Motion permission:", response);
            })
            .catch(console.error);
        }
      }

      function initARScene() {
        // On-screen control buttons
        const btns = document.createElement("div");
        btns.innerHTML = `
          <div style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
                      display:flex;gap:10px;z-index:10;">
            <button id="forward">‚Üë Forward</button>
            <button id="backward">‚Üì Back</button>
          </div>`;
        document.body.appendChild(btns);

        let z = 0;
        const step = 0.5;
        const cam = document.querySelector("#userCam");

        // Keyboard movement (for desktop)
        window.addEventListener("keydown", (e) => {
          if (e.key === "ArrowUp") z -= step;
          if (e.key === "ArrowDown") z += step;
          cam.setAttribute("position", `0 1.6 ${z}`);
        });

        // Touch button movement
        document.getElementById("forward").onclick = () => {
          z -= step;
          cam.setAttribute("position", `0 1.6 ${z}`);
        };
        document.getElementById("backward").onclick = () => {
          z += step;
          cam.setAttribute("position", `0 1.6 ${z}`);
        };

        // Load library items from JSON
fetch("libraryPath.json")
  .then((res) => res.json())
  .then((data) => {
    const scene = document.querySelector("a-scene");

    // 1Ô∏è‚É£ Draw spheres and labels
    data.points.forEach((p) => {
      const sphere = document.createElement("a-sphere");
      sphere.setAttribute("position", `${p.x} ${p.y + 1} ${p.z}`);
      sphere.setAttribute("color", "yellow");
      sphere.setAttribute("radius", "0.25");
      scene.appendChild(sphere);

      const label = document.createElement("a-text");
      label.setAttribute("value", p.label);
      label.setAttribute("position", `${p.x} ${p.y + 1.4} ${p.z}`);
      label.setAttribute("look-at", "#userCam");
      label.setAttribute("color", "white");
      label.setAttribute("align", "center");
      label.setAttribute("scale", "2 2 2");
      scene.appendChild(label);
    });

    // 2Ô∏è‚É£ Draw connecting path between waypoints
    for (let i = 0; i < data.path.length - 1; i++) {
      const p1 = data.path[i];
      const p2 = data.path[i + 1];
      const line = document.createElement("a-entity");
      line.setAttribute("line", {
        start: `${p1[0]} ${p1[1] + 1.1} ${p1[2]}`,
        end: `${p2[0]} ${p2[1] + 1.1} ${p2[2]}`,
        color: "#00FFFF"
      });
      scene.appendChild(line);
    }
  })
  .catch((err) => console.error("Error loading JSON:", err));
