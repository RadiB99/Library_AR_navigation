<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AR Item Picker Prototype</title>

    <!-- A-Frame + AR.js -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.2/aframe/build/aframe-ar.js"></script>

    <style>
      :root {
        --bg: #0f172a;
        --panel: #1e293b;
        --accent: #38bdf8;
        --text: #e2e8f0;
        --muted: #94a3b8;
      }
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        background: var(--bg);
        color: var(--text);
        overflow: hidden;
      }

      /* Welcome Screen */
      #welcomeUI {
        position: fixed;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle, #1e293b 0%, #0f172a 100%);
        z-index: 100;
        text-align: center;
        padding: 1.5rem;
      }
      #welcomeUI h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }
      #welcomeUI p {
        color: var(--muted);
        margin-bottom: 1.2rem;
      }
      #itemList {
        width: 100%;
        max-width: 350px;
        text-align: left;
      }
      .item-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.4rem;
      }
      .item-row input {
        flex: 1;
        background: var(--panel);
        color: var(--text);
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 0.5rem;
        padding: 0.55rem 0.6rem;
        outline: none;
      }
      .item-row button {
        background: #ef4444;
        color: #fff;
        border: none;
        border-radius: 0.4rem;
        padding: 0.4rem 0.6rem;
        cursor: pointer;
      }
      .actions {
        display: flex;
        gap: 0.6rem;
        justify-content: center;
        margin-top: 0.8rem;
      }
      .btn {
        background: var(--accent);
        color: #000;
        font-weight: 600;
        border: none;
        border-radius: 0.5rem;
        padding: 0.6rem 1.1rem;
        cursor: pointer;
      }
      .btn-secondary {
        background: rgba(30, 41, 59, 0.7);
        color: var(--text);
        border: 1px solid rgba(148, 163, 184, 0.3);
      }

      /* Hide AR scene by default */
      a-scene {
        display: none;
      }
    </style>
  </head>

  <body>
    <!-- Step 1: Welcome UI -->
    <div id="welcomeUI">
      <h1>ðŸ‘‹ Hello, welcome!</h1>
      <p>What can I help you pick today?</p>

      <div id="itemList"></div>

      <div class="actions">
        <button id="addItem" class="btn-secondary">+ Add Item</button>
        <button id="startAR" class="btn">Start AR Experience</button>
      </div>
    </div>

    <!-- Step 2: AR Scene -->
    <a-scene
      embedded
      arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false;"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; antialias: true;"
      device-orientation-permission-ui="enabled: true"
    >
      <a-camera id="userCam" position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
      const welcomeUI = document.getElementById("welcomeUI");
      const itemList = document.getElementById("itemList");
      const addItemBtn = document.getElementById("addItem");
      const startARBtn = document.getElementById("startAR");
      const scene = document.querySelector("a-scene");

      // start with one empty input
      addItemRow();

      addItemBtn.onclick = () => addItemRow();

      function addItemRow(defaultVal = "") {
        const row = document.createElement("div");
        row.className = "item-row";

        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "Enter item name";
        input.value = defaultVal;

        const delBtn = document.createElement("button");
        delBtn.textContent = "âœ•";
        delBtn.onclick = () => row.remove();

        row.appendChild(input);
        row.appendChild(delBtn);
        itemList.appendChild(row);
      }

      startARBtn.onclick = () => {
        const items = Array.from(itemList.querySelectorAll("input"))
          .map((i) => i.value.trim())
          .filter(Boolean);

        if (items.length === 0) {
          alert("Please enter at least one item.");
          return;
        }

        welcomeUI.style.display = "none";
        scene.style.display = "block";

        startARExperience(items);
      };

      // --- Step 2: Load scene and map items ---
      function startARExperience(items) {
        requestIOSPermission();

        // Load available coordinates from your library JSON
        fetch("libraryPath.json")
          .then((res) => res.json())
          .then((data) => {
            const availablePoints = data.points || [];
            const scene = document.querySelector("a-scene");

            // Randomly assign userâ€™s items to JSON coordinates
            items.forEach((itemName, i) => {
              const point = availablePoints[i % availablePoints.length]; // reuse if fewer coords
              const x = parseFloat(point.x);
              const y = parseFloat(point.y);
              const z = parseFloat(point.z);

              const sphere = document.createElement("a-sphere");
              sphere.setAttribute("position", `${x} ${y + 1} ${z}`);
              sphere.setAttribute("color", "yellow");
              sphere.setAttribute("radius", "0.25");
              scene.appendChild(sphere);

              const label = document.createElement("a-text");
              label.setAttribute("value", itemName);
              label.setAttribute("position", `${x} ${y + 1.4} ${z}`);
              label.setAttribute("look-at", "#userCam");
              label.setAttribute("color", "white");
              label.setAttribute("align", "center");
              label.setAttribute("scale", "2 2 2");
              scene.appendChild(label);
            });
          })
          .catch((err) => console.error("Error loading JSON:", err));
      }

      // --- iOS motion permission (required on Safari) ---
      function requestIOSPermission() {
        if (
          typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function"
        ) {
          DeviceMotionEvent.requestPermission()
            .then((response) => console.log("Motion permission:", response))
            .catch(console.error);
        }
      }
    </script>
  </body>
</html>
